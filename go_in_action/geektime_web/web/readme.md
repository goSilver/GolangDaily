
## 一、Server
对于一个web框架来说，我们首先要有一个整体代表服务器的抽象，也就是Server。
Server从特性上来说，至少要提供三部分功能：
- 生命周期控制：即启动、关闭。后期还要考虑回调特性
- 路由注册接口：提供路由注册功能
- 作为http包到web框架到桥梁

### 1.1 http.Handler接口
http包暴露了一个接口，Handler。
它是我们引入自定义web框架相关到连接点。

### 1.2 Server 接口定义
v1版本：只组合http.Handler
优点：
- Server既可以当成是普通到http.Handler来使用，又可以作为一个独立到实体，拥有自己的管理生命周期的能力
- 完全的控制，可以为所欲为

缺点：
- 如果用户不希望使用ListenAndServeTLS，那么Server需要提供HTTPS的支持

版本一和版本二都直接耦合来Go自带都http包，如果我们希望切换为fasthttp或者类似都http包，则会非常困难。

### 1.3 Server HTTPServer实现
该实现直接使用http.ListenAndServe来启动，后续可以根据需要替换为：
- 内部创建http.Serve来启动
- 使用http.Serve来启动，换取更大都灵活性，如将端口监听和服务启动分离

ServeHTTP方法则是整个web框架都核心入口，它将完成：
- Context构建
- 路由匹配
- 执行业务逻辑

### 1.4 Server addRoute方法

思考点：
1. addRoute方法只接收一个HandleFunc。因为我们希望它只注册业务逻辑。即便真有多个的场景，用户也可以自己组合成多个。
2. 如果允许注册多个，那么在实现的时候就要考虑，其中一个失败了，是否还允许继续执行下去；反过来，如果其中一个HandleFunc要中断执行，怎么中断。
3. 方法命名addRoute，比handle更友好
4. 针对不同HTTP方法的注册API，都可以委托给Handle方法

### 1.5 Server ServeHTTP方法
ServeHTTP方法是作为http包与web框架的关联点，需要在ServeHTTP内部，执行：
- 构建web框架的上下文context
- 查找路由树，并执行命中路由的函数

### 1.6 考点
1. HTTP服务器的生命周期？
   1. 一般来说就是启动、运行、关闭。在这三个阶段的前后都可以插入生命周期回调。
2. HTTP Server的功能？
   1. 提供路由注册，生命周期控制以及与http包结合的桥梁。

## 二、静态路由匹配
所谓静态匹配，就是路径的每一段都必须严格相等。后续继续优化支持通配符匹配、路径参数等复杂匹配。

### 2.1 接口设计
关键类型：
- router：维持住了所有都路由树，它是整个路由注册和查找都总入口。router里面维护了一个map，是按照HTTP方法来组织路由树都。
- node：代表的是节点。它里面有一个children的map结构，使用map结构是为来快速找到子节点。

约束：
- addRoute方法定义为私有的，用户只能通过Get或者Post方法来注册，即可确保method参数永远都是对的。
- addRoute在接口里面是私有的，限制来用户将无法实现Server。实际上如果用户想要实现Server，就约等于自己实现一个web框架了。
- path的强约束是希望用户的代码风格一只。

## 三、通配符匹配
所谓通配符匹配，是指用*号来表达匹配任何路径。要考虑几个问题：
- 如果路径是/a/b/c能不能命中/a/*路由？
- 如果注册了两个路由/user/123/home和/user/*/*。那么输入路径/user/123/detail能不能命中/user/*/*？

这两个理论上来说都可以实现，但是都不应该命中。
- 从实现都角度来说，其实并不难
- 从用户都角度来说，他们不应该设计这种路由。给用户自由但是也要限制不良实践。
- 后者要求都是一种可回溯都路由匹配。即发现/user/123/home匹配不上之后要回溯回去/user/*进一步查找，典型都投入大产出低都特性。

## 四、参数路径
所谓参数路径，就是指路径中带上参数，同时这些参数对应的值可以被业务取出来使用。

## 五、路由树总结
### 5.1 注册路由的注意事项
1. 已经注册了的路由，无法被覆盖
2. path必须以/开头，不能以/结尾，中间不能连续有/
3. 不能在同一位置注册不同的参数路由，例如：/user/:id和/user/:name冲突
4. 不能在同一位置同时注册通配符路由和参数路由，例如：/user/:id和/user/*冲突
5. 同名路径参数，在路由匹配的时候，值会被覆盖。例如：/user/:id/abc/:id，那么/user/123/abc/456最终id=456

### 5.2 为什么在注册路由时用panic？
这个地方可以返回error，那就需要用户注册时处理error。

从另一个角度来说，服务启动前路由必须注册完，才能启动HTTP Server。那么就可以采用panic，因为启动之前就代表应用还没运行。

### 5.3 路由树是线程安全的吗？
显然不是线程安全的。我们要求用户必须注册完路由才能启动HTTPServer。而正常的用法都是在启动前依次注册路由，不存在并发场景。

至于运行期间动态注册路由，没必要支持。典型的为了解决1%的需求引入99%的代码。

### 5.4 考点
1. 路由树算法？
   1. 前缀树。前缀的意思就是，两个节点共同的前缀，将会被抽取出来作为父亲节点。在我们的实现里面，是按照/来切割，每一段作为一个节点。
2. 路由匹配的优先级？
   1. 本质上这是和web框架相关的。在我们的设计里是静态匹配>路径参数>通配符匹配
3. 路由查找会回溯吗？
   1. 这个特性比较鸡肋，暂不计划支持。
4. web框架是怎么组织路由树的？
   1. 一个HTTP方法一颗路由树。
5. 路由查找的性能受什么影响？
   1. 高度、宽度。
6. 路由树是线程安全的吗？
   1. 不是。为了性能，要求服务启动前必须注册完路由。如果有运行期间动态注册路由，只需要利用装饰器模式，封装一个线程安全的路由树。
7. 具体匹配方式的实现原理
   1. 静态匹配、参数路径匹配、通配符匹配，还可以支持正则匹配






